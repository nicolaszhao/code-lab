!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("events-trigger")):"function"==typeof define&&define.amd?define(["events-trigger"],t):"object"==typeof exports?exports.AudioEngine=t(require("events-trigger")):e.AudioEngine=t(e.EventsTrigger)}(this,function(e){return function(e){function t(n){if(r[n])return r[n].exports;var i=r[n]={exports:{},id:n,loaded:!1};return e[n].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.STATES=void 0;var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(1);Object.defineProperty(t,"STATES",{enumerable:!0,get:function(){return n(a).default}});var c=r(2),f=n(c),l=r(3),d=n(l),h=0,p=function(e){return h++,e?e+"-"+h:h},v=function(e){var t=Math.floor,r=[],n=void 0,i=void 0,o=void 0,u=void 0;return e=Math.round(e),n=t(e/3600),i=t((e-3600*n)/60),u=e%60,o=function(e,t){var r=void 0,n=void 0,i=void 0;return n="",r="",e<0&&(r="-"),i=String(Math.abs(e)),i.length<t&&(n=new Array(t-i.length+1).join("0")),r+n+i},n&&r.push(n),r.push(o(i,2)),r.push(o(u,2)),r.join(":")},g=function(e){function t(e){i(this,t);var r=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e=Object.assign({volume:100,muted:!1},e),r.id=p("song"),r.url=e.url,r.volume=e.volume,r.muted=e.muted,r.startTime=e.startTime||0,r.endTime=e.endTime||0,r.duration=0,r}return u(t,e),s(t,[{key:"setVolume",value:function(e){this.volume=e}},{key:"setMute",value:function(e){this.muted=e}},{key:"setDuration",value:function(e){this.duration=e}}]),t}(f.default),y=function(){function e(){i(this,e),this.core=new d.default,this.list=[],this.cur="",this.init()}return s(e,[{key:"init",value:function(){var e=this;this.core.on("progress",function(t){var r=e.findSong(e.cur);r&&r.trigger("progress",t)}).on("error",function(t){var r=t.code,n=e.findSong(e.cur),i=void 0;n&&(i="播放资源："+n.url+"发生错误，\n\t\t\t\t\t\t错误码："+r+"，请到这里：http://www.w3school.com.cn/tags/av_prop_error.asp查找相应的信息。",n.trigger("error",new Error(i)))}).on("positionchange",function(t,r){var n=e.findSong(e.cur);if(n){if(n.endTime&&t>=n.endTime)return e.core.stop();n.trigger("positionchange",t,r||0)}}).on("statechange",function(t){var r=e.findSong(e.cur);r&&r.trigger("statechange",t)})}},{key:"reset",value:function(){for(var e=this.list.length;e--;)this.list[e].off();return this.list=[],this.cur="",this}},{key:"destroy",value:function(){this.reset(),this.core.destroy()}},{key:"add",value:function(e){return e=new g(e),this.list.push(e),e}},{key:"remove",value:function(e){for(var t=this.list.length;t--;)if(e.id===this.list[t].id){e.id===this.cur&&this.core.stop(),e.off(),this.list.splice(t,1);break}return this}},{key:"play",value:function(e){var t=this,r=void 0,n=function(e){e.setDuration(t.core.getTotalTime()),t.core.setCurrentPosition(e.startTime).setVolume(e.volume).setMute(e.muted)};return new Promise(function(i){return e.id===t.cur?(t.core.play(),i(e)):t.cur&&(t.core.stop(),r=t.list.find(function(e){return e.id===t.cur}),r&&r.url===e.url)?(t.cur=e.id,n(e),t.core.play(),i(e)):(t.cur=e.id,void t.core.setUrl(e.url).then(function(){n(e),t.core.play(),i(e)}))})}},{key:"pause",value:function(){return this.core.pause(),this}},{key:"setVolume",value:function(e,t){return e.id===this.cur&&this.core.setVolume(t),e.setVolume(t),this}},{key:"setMute",value:function(e,t){return e.id===this.cur&&this.core.setMute(t),e.setMute(t),this}},{key:"setPosition",value:function(e,t){return e.id===this.cur&&this.core.setCurrentPosition(t),this}},{key:"formatTime",value:function(e){return v(e)}},{key:"findSong",value:function(e){return this.list.find(function(t){return t.id===e})}}]),e}();t.default=y},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r={PREBUFFER:"waiting",BUFFERING:"loadeddata",PLAYING:"playing",PAUSE:"pause",STOP:"suspend",END:"ended"};t.default=r},function(t,r){t.exports=e},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(2),c=n(a),f=r(1),l=n(f),d=function(e){function t(){i(this,t);var e=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this)),r=new Audio;return r.preload=!1,r.autoplay=!1,r.loop=!1,e.audio=r,e._canPlayThrough=!1,e._url="",e.init(),e}return u(t,e),s(t,[{key:"init",value:function(){var e=this,t=function(){var t=e.getLoadedPercent();return e.trigger("progress",t),1===t&&(e._canPlayThrough=!0),t};this.eventHandlers={loadstart:function(){var r=function r(){e.progressTimer=setTimeout(function(){t()<1&&r()},50)};e._canPlayThrough=!1,clearTimeout(e.progressTimer),r()},progress:function(){clearTimeout(e.progressTimer),e._canPlayThrough||t()},playing:function(){clearTimeout(e.errorTimer),e.setState(l.default.PLAYING)},error:function(t){return clearTimeout(e.errorTimer),e.errorTimer=setTimeout(function(){return e.trigger("error",t)},2e3)},ended:function(){e.setState(l.default.END)},waiting:function(){e.setState(l.default.PREBUFFER)},loadeddata:function(){e.setState(l.default.BUFFERING)},timeupdate:function(){var t=e.getCurrentPosition();e.trigger("positionchange",t,1*(t/e.getTotalTime()).toFixed(2)||0)}};for(var r in this.eventHandlers)this.audio.addEventListener(r,this.eventHandlers[r],!1)}},{key:"destroy",value:function(){this.reset().off();for(var e in this.eventHandlers)this.audio.removeEventListener(e,this.eventHandlers[e],!1)}},{key:"reset",value:function(){return this.stop(),this._url="",this._canPlayThrough=!1,this.trigger("progress",0),this.trigger("positionchange",0),this}},{key:"getLoadedPercent",value:function(){var e=void 0,t=void 0,r=void 0,n=this.audio,i=n.buffered,o=n.duration;if(e=n.currentTime,i)for(t=i.length,r=n.currentTime;t--;)if(i.start(t)<=r&&r<=i.end(t)){e=i.end(t);break}return 1*(e/o).toFixed(2)||0}},{key:"getCurrentPosition",value:function(){return this.audio.currentTime}},{key:"setCurrentPosition",value:function(e){try{this.audio.currentTime=e}catch(e){}return this}},{key:"getTotalTime",value:function(){return this.audio.duration||0}},{key:"setState",value:function(e){if(this._url||(e=l.default.STOP),e!==this._state&&(!this._canPlayThrough||e!==l.default.PREBUFFER&&e!==l.default.BUFFERING))return this._state=e,this.trigger("statechange",e)}},{key:"getState",value:function(){return this._state}},{key:"setUrl",value:function(e){var t=this,r=this,n=function e(t){r.audio.readyState>2?(clearTimeout(r.checkStartTimer),t()):r.checkStartTimer=setTimeout(function(){e(t)},50)};return new Promise(function(r,i){e?(t._url=e,t.audio.src=e,t.audio.load(),n(r)):i()})}},{key:"play",value:function(){return this.audio.play(),this}},{key:"pause",value:function(){return this.audio.pause(),this.setState(l.default.PAUSE),this}},{key:"stop",value:function(){this.audio.pause();try{this.audio.currentTime=0}catch(e){}return this.trigger("positionchange",0),this.setState(l.default.STOP)}},{key:"setVolume",value:function(e){return"number"==typeof e&&e>=0&&e<=100&&(this.audio.volume=e/100),this}},{key:"getVolume",value:function(){return parseInt(100*this.audio.volume)}},{key:"setMute",value:function(e){return this.audio.muted=!!e,this}},{key:"getMute",value:function(){return this.audio.muted}}]),t}(c.default);t.default=d}])});